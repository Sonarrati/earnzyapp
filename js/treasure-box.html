import { auth, db } from './firebase-init.js';
import { 
    doc, 
    getDoc, 
    updateDoc,
    collection,
    getDocs,
    query,
    where,
    orderBy,
    serverTimestamp,
    increment 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

let currentUser = null;
let userData = null;
let treasureReward = 0;
let isUnlocked = false;
let isOpened = false;

// Initialize treasure box page
document.addEventListener('DOMContentLoaded', async () => {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            await loadUserData();
            await loadTreasureHistory();
            checkTreasureStatus();
        } else {
            window.location.href = 'login.html';
        }
    });
});

// Load user data
async function loadUserData() {
    try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
            userData = userDoc.data();
            
            // Update UI
            document.getElementById('userBalance').textContent = userData.balance?.toFixed(2) || '0.00';
            
            // Update progress
            const tasksCompleted = userData.tasksCompletedToday || 0;
            const adsWatched = userData.adsWatchedToday || 0;
            
            document.getElementById('tasksProgress').textContent = tasksCompleted;
            document.getElementById('adsProgress').textContent = adsWatched;
            document.getElementById('tasksStatus').textContent = `${tasksCompleted}/3`;
            document.getElementById('adsStatus').textContent = `${adsWatched}/5`;
            
            // Update progress bars
            const tasksProgress = Math.min((tasksCompleted / 3) * 100, 100);
            const adsProgress = Math.min((adsWatched / 5) * 100, 100);
            
            document.getElementById('tasksProgressBar').style.width = `${tasksProgress}%`;
            document.getElementById('adsProgressBar').style.width = `${adsProgress}%`;
            
            // Check if treasure was already opened today
            const today = new Date().toDateString();
            const lastTreasure = userData.lastTreasureOpened ? 
                new Date(userData.lastTreasureOpened.toDate()).toDateString() : null;
            
            isOpened = lastTreasure === today;
        }
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}

// Check treasure box status
function checkTreasureStatus() {
    const tasksCompleted = userData.tasksCompletedToday || 0;
    const adsWatched = userData.adsWatchedToday || 0;
    
    isUnlocked = tasksCompleted >= 3 || adsWatched >= 5;
    
    if (isOpened) {
        // Already opened today
        showOpenedState();
    } else if (isUnlocked) {
        // Unlocked but not opened
        showUnlockedState();
    } else {
        // Locked
        showLockedState();
    }
}

// Show locked state
function showLockedState() {
    document.getElementById('lockedState').classList.remove('hidden');
    document.getElementById('unlockedState').classList.add('hidden');
    document.getElementById('openedState').classList.add('hidden');
    
    document.getElementById('unlockBtn').classList.remove('hidden');
    document.getElementById('openBtn').classList.add('hidden');
    document.getElementById('collectBtn').classList.add('hidden');
    
    document.getElementById('unlockBtn').disabled = true;
}

// Show unlocked state
function showUnlockedState() {
    document.getElementById('lockedState').classList.add('hidden');
    document.getElementById('unlockedState').classList.remove('hidden');
    document.getElementById('openedState').classList.add('hidden');
    
    document.getElementById('unlockBtn').classList.add('hidden');
    document.getElementById('openBtn').classList.remove('hidden');
    document.getElementById('collectBtn').classList.add('hidden');
    
    // Add click event to treasure box
    document.getElementById('unlockedState').addEventListener('click', openTreasureBox);
    document.getElementById('openBtn').addEventListener('click', openTreasureBox);
}

// Show opened state
function showOpenedState() {
    document.getElementById('lockedState').classList.add('hidden');
    document.getElementById('unlockedState').classList.add('hidden');
    document.getElementById('openedState').classList.remove('hidden');
    
    document.getElementById('unlockBtn').classList.add('hidden');
    document.getElementById('openBtn').classList.add('hidden');
    document.getElementById('collectBtn').classList.add('hidden');
    
    // Show yesterday's reward
    if (userData.lastTreasureReward) {
        document.getElementById('treasureReward').textContent = `₹${userData.lastTreasureReward.toFixed(2)}`;
    }
}

// Open treasure box
async function openTreasureBox() {
    if (!isUnlocked || isOpened) return;
    
    // Generate random reward (₹1 - ₹3)
    treasureReward = generateRandomReward();
    
    // Show reward with animation
    document.getElementById('unlockedState').classList.add('hidden');
    document.getElementById('openedState').classList.remove('hidden');
    document.getElementById('treasureReward').textContent = `₹${treasureReward.toFixed(2)}`;
    
    // Show collect button
    document.getElementById('collectBtn').classList.remove('hidden');
    document.getElementById('openBtn').classList.add('hidden');
    
    // Create confetti effect
    createConfetti();
}

// Generate random treasure reward
function generateRandomReward() {
    const min = 1.00;
    const max = 3.00;
    const random = Math.random();
    const amount = min + (random * (max - min));
    return Math.round(amount * 100) / 100; // Round to 2 decimal places
}

// Collect reward
document.getElementById('collectBtn').addEventListener('click', async () => {
    await collectTreasureReward();
});

// Collect treasure reward
async function collectTreasureReward() {
    try {
        // Update user data
        await updateDoc(doc(db, 'users', currentUser.uid), {
            balance: increment(treasureReward),
            totalEarned: increment(treasureReward),
            lastTreasureOpened: serverTimestamp(),
            lastTreasureReward: treasureReward,
            treasureOpenedToday: true
        });
        
        // Create treasure record
        await updateDoc(doc(db, 'treasures', currentUser.uid + '_' + Date.now()), {
            userId: currentUser.uid,
            reward: treasureReward,
            unlockedBy: getUnlockMethod(),
            createdAt: serverTimestamp()
        });
        
        // Create transaction record
        await updateDoc(doc(db, 'transactions', currentUser.uid + '_' + Date.now()), {
            userId: currentUser.uid,
            amount: treasureReward,
            type: 'credit',
            description: 'Treasure Box Reward',
            createdAt: serverTimestamp()
        });
        
        // Show success modal
        showSuccessModal();
        
        // Update UI
        document.getElementById('userBalance').textContent = (userData.balance + treasureReward).toFixed(2);
        document.getElementById('collectBtn').classList.add('hidden');
        
        // Reload history
        await loadTreasureHistory();
        
    } catch (error) {
        console.error('Error collecting treasure reward:', error);
        showErrorMessage('Error collecting reward. Please try again.');
    }
}

// Get unlock method
function getUnlockMethod() {
    const tasksCompleted = userData.tasksCompletedToday || 0;
    const adsWatched = userData.adsWatchedToday || 0;
    
    if (tasksCompleted >= 3 && adsWatched >= 5) return 'both';
    if (tasksCompleted >= 3) return 'tasks';
    if (adsWatched >= 5) return 'ads';
    return 'unknown';
}

// Load treasure history
async function loadTreasureHistory() {
    try {
        const historyQuery = query(
            collection(db, 'treasures'),
            where('userId', '==', currentUser.uid),
            orderBy('createdAt', 'desc'),
            
        );
        
        const querySnapshot = await getDocs(historyQuery);
        const historyContainer = document.getElementById('treasureHistory');
        historyContainer.innerHTML = '';
        
        if (querySnapshot.empty) {
            historyContainer.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-history text-2xl mb-2"></i>
                    <p>No treasure history yet</p>
                </div>
            `;
            return;
        }
        
        querySnapshot.forEach(doc => {
            const treasure = doc.data();
            const historyItem = createTreasureHistoryItem(treasure);
            historyContainer.appendChild(historyItem);
        });
        
    } catch (error) {
        console.error('Error loading treasure history:', error);
    }
}

// Create treasure history item
function createTreasureHistoryItem(treasure) {
    const item = document.createElement('div');
    item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-xl';
    
    const date = treasure.createdAt.toDate();
    const formattedDate = date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
    });
    
    let unlockMethod = '';
    switch(treasure.unlockedBy) {
        case 'tasks': unlockMethod = ' (Tasks)'; break;
        case 'ads': unlockMethod = ' (Ads)'; break;
        case 'both': unlockMethod = ' (Tasks+Ads)'; break;
    }
    
    item.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-gem text-yellow-500 mr-3"></i>
            <div>
                <div class="font-semibold">Treasure Box${unlockMethod}</div>
                <div class="text-sm text-gray-600">${formattedDate}</div>
            </div>
        </div>
        <div class="text-green-600 font-bold">+₹${treasure.reward.toFixed(2)}</div>
    `;
    
    return item;
}

// Create confetti effect
function createConfetti() {
    const container = document.getElementById('treasureContainer');
    const colors = ['#f59e0b', '#fbbf24', '#f97316', '#eab308', '#d97706'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        
        container.appendChild(confetti);
        
        // Animate confetti
        setTimeout(() => {
            confetti.style.transition = 'all 1s ease-out';
            confetti.style.opacity = '1';
            confetti.style.transform = `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) rotate(${Math.random() * 360}deg)`;
            
            setTimeout(() => {
                confetti.style.opacity = '0';
                setTimeout(() => confetti.remove(), 1000);
            }, 500);
        }, i * 20);
    }
}

// Show success modal
function showSuccessModal() {
    document.getElementById('modalReward').textContent = `₹${treasureReward.toFixed(2)}`;
    document.getElementById('successModal').classList.remove('hidden');
}

// Close success modal
document.getElementById('closeSuccess').addEventListener('click', () => {
    document.getElementById('successModal').classList.add('hidden');
});

// Show error message
function showErrorMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
